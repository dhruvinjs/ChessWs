{
  "description": "WebSocket Payloads for Chess Room Manager - Complete Testing Guide",
  "setup_instructions": [
    "1. Create a room via HTTP API (Alice creates, gets room code)",
    "2. Join room via HTTP API (Bob joins with room code)",
    "3. Open WebSocket connections for both users (ws://localhost:PORT/room?userId=1 for Alice, ws://localhost:PORT/room?userId=2 for Bob)",
    "4. Follow the message flows below in order",
    "5. Replace ROOM_CODE with actual code from step 1",
    "6. Replace GAME_ID with actual game ID returned after init_room_game"
  ],

  "http_endpoints": {
    "create_room": {
      "method": "POST",
      "url": "http://localhost:3000/api/room/create",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer <ALICE_TOKEN>"
      },
      "body": {
        "userId": 1
      },
      "expected_response": {
        "roomCode": "ABC123",
        "roomId": 1,
        "status": "WAITING"
      }
    },
    "join_room": {
      "method": "POST",
      "url": "http://localhost:3000/api/room/join",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer <BOB_TOKEN>"
      },
      "body": {
        "roomCode": "ABC123",
        "userId": 2
      },
      "expected_response": {
        "message": "Joined room successfully",
        "roomCode": "ABC123"
      }
    }
  },

  "websocket_flows": [
    {
      "step": 1,
      "flow_name": "Alice Opens WebSocket Connection",
      "purpose": "Alice connects to WebSocket server",
      "direction": "Client -> Server (Connection)",
      "url": "ws://localhost:3000/room?userId=1",
      "expected_server_response": {
        "type": "assign_id_for_room",
        "payload": {
          "message": "Id Assigned for room"
        }
      }
    },
    {
      "step": 2,
      "flow_name": "Bob Opens WebSocket Connection",
      "purpose": "Bob connects to WebSocket server",
      "direction": "Client -> Server (Connection)",
      "url": "ws://localhost:3000/room?userId=2",
      "expected_server_response": {
        "type": "assign_id_for_room",
        "payload": {
          "message": "Id Assigned for room"
        }
      },
      "alice_receives": {
        "type": "user_has_joined",
        "payload": {
          "message": "Opponent has joined!",
          "opponentId": 2
        }
      }
    },
    {
      "step": 3,
      "flow_name": "Alice Initializes Game (Creator Starts)",
      "purpose": "Alice (room creator) starts the game. This creates the Game record in DB and notifies both players.",
      "direction": "Alice (Client 1) -> Server",
      "sender": "Alice (userId: 1)",
      "message_to_send": {
        "type": "init_room_game",
        "payload": {
          "roomId": "ABC123"
        }
      },
      "expected_alice_response": {
        "type": "init_room_game",
        "payload": {
          "gameId": 101,
          "color": "w",
          "fen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
          "opponentId": 2,
          "whiteTimer": 600,
          "blackTimer": 600
        }
      },
      "expected_bob_response": {
        "type": "init_room_game",
        "payload": {
          "gameId": 101,
          "color": "b",
          "fen": "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",
          "opponentId": 1,
          "whiteTimer": 600,
          "blackTimer": 600
        }
      }
    },
    {
      "step": 4,
      "flow_name": "Alice Makes First Move (e2-e4)",
      "purpose": "White (Alice) makes opening move",
      "direction": "Alice (Client 1) -> Server",
      "sender": "Alice (userId: 1)",
      "message_to_send": {
        "type": "room_move",
        "payload": {
          "gameId": 101,
          "from": "e2",
          "to": "e4",
          "promotion": null
        }
      },
      "expected_alice_response": {
        "type": "room_move",
        "payload": {
          "move": {
            "from": "e2",
            "to": "e4",
            "promotion": null
          },
          "turn": "b",
          "fen": "rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1",
          "validMoves": []
        }
      },
      "expected_bob_response": {
        "type": "room_move",
        "payload": {
          "move": {
            "from": "e2",
            "to": "e4",
            "promotion": null
          },
          "turn": "b",
          "fen": "rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1",
          "validMoves": [
            { "from": "a7", "to": "a6", "promotion": null },
            { "from": "a7", "to": "a5", "promotion": null }
          ]
        }
      }
    },
    {
      "step": 5,
      "flow_name": "Bob Makes Response Move (d7-d5)",
      "purpose": "Black (Bob) responds with center pawn",
      "direction": "Bob (Client 2) -> Server",
      "sender": "Bob (userId: 2)",
      "message_to_send": {
        "type": "room_move",
        "payload": {
          "gameId": 101,
          "from": "d7",
          "to": "d5",
          "promotion": null
        }
      },
      "expected_bob_response": {
        "type": "room_move",
        "payload": {
          "move": {
            "from": "d7",
            "to": "d5",
            "promotion": null
          },
          "turn": "w",
          "fen": "rnbqkbnr/ppp1pppp/8/3p4/4P3/8/PPPP1PPP/RNBQKBNR w KQkq d6 0 2",
          "validMoves": []
        }
      },
      "expected_alice_response": {
        "type": "room_move",
        "payload": {
          "move": {
            "from": "d7",
            "to": "d5",
            "promotion": null
          },
          "turn": "w",
          "fen": "rnbqkbnr/ppp1pppp/8/3p4/4P3/8/PPPP1PPP/RNBQKBNR w KQkq d6 0 2",
          "validMoves": [
            { "from": "e4", "to": "e5", "promotion": null },
            { "from": "e4", "to": "d5", "promotion": null }
          ]
        }
      }
    },
    {
      "step": 6,
      "flow_name": "Timer Update (Automatic)",
      "purpose": "Server broadcasts timer updates every second while game is active",
      "direction": "Server -> Both Clients (Automatic)",
      "trigger": "Automatic (every 1 second)",
      "expected_broadcast": {
        "type": "room_timer_update",
        "payload": {
          "whiteTimer": 595,
          "blackTimer": 597
        }
      }
    },
    {
      "step": 7,
      "flow_name": "Wrong Turn Error Test",
      "purpose": "Test validation - Alice tries to move on Bob's turn",
      "direction": "Alice (Client 1) -> Server",
      "sender": "Alice (userId: 1)",
      "message_to_send": {
        "type": "room_move",
        "payload": {
          "gameId": 101,
          "from": "e1",
          "to": "e2",
          "promotion": null
        }
      },
      "expected_alice_response": {
        "type": "wrong_player_move",
        "payload": {
          "message": "Not your turn"
        }
      }
    },
    {
      "step": 8,
      "flow_name": "Illegal Move Test",
      "purpose": "Test validation - Bob tries illegal move",
      "direction": "Bob (Client 2) -> Server",
      "sender": "Bob (userId: 2)",
      "message_to_send": {
        "type": "room_move",
        "payload": {
          "gameId": 101,
          "from": "d5",
          "to": "d7",
          "promotion": null
        }
      },
      "expected_bob_response": {
        "type": "illegal_room_move",
        "payload": {
          "message": "Server error while processing move or illegal move attempted"
        }
      }
    },
    {
      "step": 9,
      "flow_name": "Bob Disconnects (Simulate)",
      "purpose": "Bob closes WebSocket connection",
      "direction": "Bob -> Server (Disconnect)",
      "action": "Close Bob's WebSocket connection",
      "note": "No message sent, just close the connection"
    },
    {
      "step": 10,
      "flow_name": "Bob Reconnects",
      "purpose": "Bob reconnects and requests game state",
      "direction": "Bob (Client 2) -> Server",
      "url": "ws://localhost:3000/room?userId=2",
      "first_message_after_connect": {
        "type": "reconnect",
        "payload": {
          "gameId": 101
        }
      },
      "expected_bob_response": {
        "type": "room_reconnect",
        "payload": {
          "gameId": 101,
          "fen": "rnbqkbnr/ppp1pppp/8/3p4/4P3/8/PPPP1PPP/RNBQKBNR w KQkq d6 0 2",
          "whiteTimer": 580,
          "blackTimer": 590,
          "color": "b",
          "opponentId": 1,
          "moves": [
            { "from": "e2", "to": "e4" },
            { "from": "d7", "to": "d5" }
          ]
        }
      },
      "expected_alice_response": {
        "type": "opp_room_reconnect",
        "payload": {
          "message": "Opponent reconnected"
        }
      }
    },
    {
      "step": 11,
      "flow_name": "Bob Resigns (Leave Game)",
      "purpose": "Bob leaves/resigns the game",
      "direction": "Bob (Client 2) -> Server",
      "sender": "Bob (userId: 2)",
      "message_to_send": {
        "type": "room_leave_game",
        "payload": {
          "gameId": 101
        }
      },
      "expected_bob_response": {
        "type": "room_game_over",
        "payload": {
          "result": "lose",
          "reason": "resignation",
          "message": "You resigned. Better luck next time!"
        }
      },
      "expected_alice_response": {
        "type": "room_game_over",
        "payload": {
          "result": "win",
          "reason": "opponent_resigned",
          "message": "Your opponent resigned. You win!"
        }
      }
    }
  ],

  "error_scenarios": [
    {
      "scenario": "Invalid Room Code",
      "message_to_send": {
        "type": "init_room_game",
        "payload": {
          "roomId": "INVALID"
        }
      },
      "expected_response": {
        "type": "room_not_found",
        "payload": {
          "message": "Room not found!"
        }
      }
    },
    {
      "scenario": "Non-Creator Tries to Start Game",
      "sender": "Bob (userId: 2)",
      "message_to_send": {
        "type": "init_room_game",
        "payload": {
          "roomId": "ABC123"
        }
      },
      "expected_response": {
        "type": "unauthorized",
        "payload": {
          "message": "Only the room creator can start the game"
        }
      }
    },
    {
      "scenario": "Start Game Without Opponent",
      "sender": "Alice (userId: 1)",
      "condition": "Bob hasn't joined yet",
      "message_to_send": {
        "type": "init_room_game",
        "payload": {
          "roomId": "ABC123"
        }
      },
      "expected_response": {
        "type": "room_not_ready",
        "payload": {
          "message": "Waiting for opponent to join"
        }
      }
    },
    {
      "scenario": "Game Already Started",
      "sender": "Alice (userId: 1)",
      "condition": "Game already initialized",
      "message_to_send": {
        "type": "init_room_game",
        "payload": {
          "roomId": "ABC123"
        }
      },
      "expected_response": {
        "type": "room_game_active_error",
        "payload": {
          "message": "Game already started!"
        }
      }
    },
    {
      "scenario": "Move on Non-Existent Game",
      "message_to_send": {
        "type": "room_move",
        "payload": {
          "gameId": 99999,
          "from": "e2",
          "to": "e4",
          "promotion": null
        }
      },
      "expected_response": {
        "type": "room_game_not_found",
        "payload": {
          "message": "Game not found or finished"
        }
      }
    },
    {
      "scenario": "Reconnect to Finished Game",
      "message_to_send": {
        "type": "reconnect",
        "payload": {
          "gameId": 101
        }
      },
      "condition": "Game status is FINISHED",
      "expected_response": {
        "type": "no_room_reconnection",
        "payload": {
          "message": "Game reconnection not possible - game is finished"
        }
      }
    }
  ],

  "notes": {
    "important": [
      "Always replace ROOM_CODE with actual room code from HTTP API",
      "Always replace GAME_ID (101) with actual game ID from init_room_game response",
      "userId is passed via WebSocket connection URL query parameter",
      "Timer updates happen automatically every second for active games",
      "White player is always the room creator (user1)",
      "Black player is always the room joiner (user2)"
    ],
    "testing_tips": [
      "Use a WebSocket client like Postman, wscat, or browser WebSocket",
      "Keep both connections open to see both sides of communication",
      "Check Redis with: redis-cli HGETALL room-game:101",
      "Check DB with: SELECT * FROM Game WHERE id = 101",
      "Monitor server logs for debugging"
    ]
  }
}
